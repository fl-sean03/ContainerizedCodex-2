# Mocked and Live Test Matrix — 2025-11-14T12:39Z

1. Overview
- Purpose: Define comprehensive validation for the Codex Workspace Orchestrator in both mocked and live modes, aligned with the developer guide.
- Outcomes:
  - Mocked mode (USE_DUMMY_WORKER=True) end-to-end verification.
  - Live mode (USE_DUMMY_WORKER=False) verification with real worker container and env passthrough.
  - Clear acceptance criteria, evidence to capture, and rollback steps.
- Scope: Only validation and testing; no unrelated refactors.

2. References (context bundle)
- Compose and docs: [docker-compose.yml](docker-compose.yml), [README.md](README.md), [DEV_GUIDE.md](DEV_GUIDE.md)
- Backend app: [backend/main.py](backend/main.py:1), [backend/app/core/config.py](backend/app/core/config.py:1)
- API routes: [projects](backend/app/api/routes/projects.py:20), [files](backend/app/api/routes/files.py:12), [jobs](backend/app/api/routes/jobs.py:12)
- Runner: [run_codex_job()](backend/app/services/codex_runner.py:59), [dummy_worker_generate_snake_game()](backend/app/services/codex_runner.py:29)
- Security and FS: [workspaces service](backend/app/services/workspaces.py:1)
- DB/migrations: [backend/app/db/models.py](backend/app/db/models.py:1), [backend/alembic/env.py](backend/alembic/env.py:1)

3. Environments
- Mocked mode
  - USE_DUMMY_WORKER=True in [.env](.env)
  - Verifies orchestration, workspace writing, and file APIs using the dummy minimal Python CLI (Fibonacci) generator.
- Live mode
  - USE_DUMMY_WORKER=False, [CODEX_WORKER_IMAGE](backend/app/core/config.py:18) set to actual image.
  - [run_codex_job()](backend/app/services/codex_runner.py:59) launches docker with:
    - -v <workspace>:/workspace
    - -e OPENAI_API_KEY -e OPENAI_ORG_ID -e OPENAI_PROJECT
  - Secrets sourced from [.env.live](.env.live); never printed.

4. Test Cases — Mocked Mode
- M01 Create Project (happy path)
  - Pre: Backend running via docker-compose.
  - Steps: POST [/api/v1/projects](backend/app/api/routes/projects.py:20) with {"instruction":"Generate a minimal Python CLI project that prints the first 10 Fibonacci numbers and includes a basic test."}
  - Expected: 200; status=completed; workspace created; summary indicates completion.
- M02 List Files
  - Steps: GET [/api/v1/{project_id}/files](backend/app/api/routes/files.py:12)
  - Expected: files include ".codex/request.json", ".codex/result.json", "README.md", "app.py", "tests/test_cli.py".
- M03 Get File
  - Steps: GET [/api/v1/{project_id}/files/app.py](backend/app/api/routes/files.py:21)
  - Expected: 200; non-empty contents string.
- M04 Edit Job
  - Steps: POST [/api/v1/{project_id}/jobs](backend/app/api/routes/jobs.py:12) {"job_type":"edit","instruction":"Append a comment line to app.py describing the change."}
  - Expected: 200; status=completed (dummy behavior).
- M05 Path Traversal Blocked
  - Steps: GET /files/..%2Fetc%2Fpasswd (URL-encoded traversal)
  - Expected: 400 Invalid path (blocked by safe resolver).
- M06 Absolute Path Blocked
  - Steps: GET /files//etc/passwd
  - Expected: 400 Invalid path.
- M07 Safe Nonexistent File
  - Steps: GET /files/does-not-exist.txt
  - Expected: 404 Not found.
- M08 Symlink Escape Blocked (if symlinks supported)
  - Setup: Create symlink in workspace to /tmp (or outside).
  - Steps: GET /files/symlinked-escape/secret
  - Expected: 400 Invalid path (escape blocked).
- M09 Workspace Artifacts
  - Steps: Inspect backend/workspaces/{project_id}/
  - Expected: Presence of .codex/{request.json,result.json}; result.json.status=success; created_files includes README.md, app.py, tests/test_cli.py.

5. Test Cases — Live Mode
- Preconditions for all Live tests
  - [.env.live](.env.live) exists with OPENAI_API_KEY, OPENAI_ORG_ID, OPENAI_PROJECT; .gitignore excludes it.
  - [.env](.env) updated: USE_DUMMY_WORKER=False; CODEX_WORKER_IMAGE points to actual worker.
  - [run_codex_job()](backend/app/services/codex_runner.py:59) passes env vars via -e flags; worker logs only presence (not values).
- L01 Worker Env Presence (instrumentation)
  - Steps: Trigger any job; capture worker logs/result.json logs field.
  - Expected: Logs indicate presence of OPENAI_* vars; no secret values printed.
- L02 Create Project Live
  - Steps: POST [/api/v1/projects](backend/app/api/routes/projects.py:20) with {"instruction":"Generate a minimal Python CLI project that prints the first 10 Fibonacci numbers and includes a basic test."}
  - Expected: 200; job runs via docker; .codex/result.json written with status=success or status=error with summary; Job.status reflects result.
- L03 List Files Live
  - Steps: GET [/api/v1/{project_id}/files](backend/app/api/routes/files.py:12)
  - Expected: Includes .codex/{request.json,result.json}; other artifacts depend on worker output.
- L04 Get Representative File
  - Steps: GET a file produced by the worker (app.py)
  - Expected: 200; non-empty contents.
- L05 Edit Job Live
  - Steps: POST [/api/v1/{project_id}/jobs](backend/app/api/routes/jobs.py:12) with {"job_type":"edit","instruction":"Append a comment line to app.py describing the change."}
  - Expected: 200; result.json indicates modified_files or a clear error; updated artifacts if success.
- L06 Error Handling / Timeout
  - Steps: Use an intentionally difficult instruction or set a short timeout (if supported) to provoke failure.
  - Expected: Job.status=error; result.json includes summary/errors; API remains responsive.
- L07 Rollback to Mocked
  - Steps: Restore USE_DUMMY_WORKER=True in [.env](.env); docker-compose rebuild/up.
  - Expected: Mocked tests (M01–M09) pass again.

6. Acceptance Criteria
- Mocked mode
  - M01–M04 return 200 and expected payloads; M05–M06 return 400; M07 returns 404; M08 blocked; M09 artifacts verified.
- Live mode
  - L01 confirms env presence without secrets.
  - L02–L05 produce .codex/result.json; status success or structured error; system stability maintained.
  - L06 validates error path; L07 validates rollback works.
- Documentation
  - README/DEV_GUIDE updated with live testing guidance, rollback steps, and secret-handling notes.

7. Evidence to Capture (store under docs/evidence/<timestamp>/)
- API responses (JSON) for M01–M04 and L02–L05.
- Directory listings of backend/workspaces/{project_id}/ (text).
- Excerpts from .codex/result.json (status, summary, created_files/modified_files) with no secrets.
- Backend logs: request lines and worker invocation info (no secret values).
- Note: Do not store any secret material.

8. Execution Notes
- Use curl or Swagger for API calls; prefer trailing slash for POST /projects to avoid 307.
- If port 8000 is occupied, update [docker-compose.yml](docker-compose.yml) to 8001:8000 temporarily and document the change.
- Ensure Alembic runs on startup ([backend/alembic/env.py](backend/alembic/env.py:1)); no implicit Base.metadata.create_all in runtime paths.

9. Risk Controls
- Secret leakage: enforce presence-only logging; verify [.gitignore](.gitignore) includes .env and .env.live.
- Worker instability: capture structured errors in result.json; no crash loops; document retry/backoff in roadmap (future work).
- Filesystem traversal: validated in mocked tests; same safe resolver applies in live.

10. Exit Criteria
- All mocked tests M01–M09 pass.
- Live tests L01–L07 executed with evidence captured; results are coherent and non-destructive.
- Documentation updated; rollback to mocked verified.
---
Appendix A — Run Order (Mocked → Live → Rollback)

- Order of execution
  1) Mocked mode: M01–M09
  2) Live mode: L01–L07
  3) Rollback: restore mocked mode and re-run M01–M04 smoke
- Rationale
  - Establishes baseline behavior with dummy worker first.
  - Validates real container path next using presence-only secret handling.
  - Ensures recovery by switching back to mocked mode.

---
Appendix B — Rollback Procedure (Authoritative)

- Steps
  - Edit [.env](.env): set USE_DUMMY_WORKER=True
  - docker-compose build
  - docker-compose up
  - Verify via Swagger at /docs and run M01–M04
- Evidence (store under docs/evidence/&lt;timestamp&gt;/live/L07 and docs/evidence/&lt;timestamp&gt;/mocked/RERUN)
  - live/L07/notes.txt: actions taken to rollback
  - mocked/RERUN/summary.txt: short confirmation of M01–M04 success

---
Appendix C — Detailed Test Specifications (Acceptance Criteria, Evidence, Failure Handling)

References
- API routes: [projects](backend/app/api/routes/projects.py:20), [files](backend/app/api/routes/files.py:12), [jobs](backend/app/api/routes/jobs.py:12)
- Runner: [run_codex_job()](backend/app/services/codex_runner.py:60)
- Compose: [docker-compose.yml](docker-compose.yml:1)

Conventions
- BASE default: http://localhost:8000
- Timestamp root: docs/evidence/&lt;ISO8601Z&gt;/{mocked|live}/
- Evidence filenames: response.json, files.json, file.json or index.json, result.json, result_excerpt.txt, project_id.txt, dirlist.txt, notes.txt
- Secrets: Never printed or stored; logs must show presence-only.

Mocked Mode
- M01 Create Project (happy path)
  - Endpoint: POST /api/v1/projects/ ([projects](backend/app/api/routes/projects.py:20))
  - Payload: {"instruction":"Generate a minimal Python CLI project that prints the first 10 Fibonacci numbers and includes a basic test."}
  - Expected: HTTP 200; JSON includes id (UUID), status="completed", summary (string), workspace_path (string)
  - Acceptance:
    - backend/workspaces/{id}/ exists with README.md, app.py, tests/test_cli.py
    - .codex/result.json exists with status="success"; created_files contains those 3 files
  - Evidence:
    - mocked/M01/response.json
    - mocked/M01/project_id.txt
    - mocked/M01/result.json
    - mocked/M01/result_excerpt.txt (status, summary, created_files)
  - Failure handling: Any non-200 or missing files → FAIL; capture response.json and notes.txt

- M02 List Files
  - Endpoint: GET /api/v1/{project_id}/files ([files](backend/app/api/routes/files.py:12))
  - Expected: HTTP 200; includes ".codex/request.json", ".codex/result.json", "README.md", "app.py", "tests/test_cli.py"
  - Acceptance: All 5 filenames present
  - Evidence: mocked/M02/files.json; optional mocked/M02/dirlist.txt
  - Failure handling: Missing any expected file → FAIL; record files.json

  - Note (consistency with new file-based payloads): For M03, use app.py as the representative file.
    - Endpoint: GET /api/v1/{project_id}/files/app.py ([files](backend/app/api/routes/files.py:21))
    - Evidence filename: mocked/M03/app.json
- M03 Get File (index.html)
  - Endpoint: GET /api/v1/{project_id}/files/index.html ([files](backend/app/api/routes/files.py:21))
  - Expected: HTTP 200; JSON with contents (non-empty)
  - Acceptance: contents length &gt; 0
  - Evidence: mocked/M03/index.json
  - Failure handling: 4xx/5xx or empty contents → FAIL

- M04 Edit Job
  - Endpoint: POST /api/v1/{project_id}/jobs ([jobs](backend/app/api/routes/jobs.py:12))
  - Payload: {"job_type":"edit","instruction":"Append a comment line to app.py describing the change."}
  - Expected: HTTP 200; JSON status="completed" (dummy)
  - Acceptance: status="completed" in API; .codex/result.json logs mention dummy worker
  - Evidence: mocked/M04/response.json; mocked/M04/result.json; mocked/M04/result_excerpt.txt
  - Failure handling: Non-200 or missing result.json → FAIL

- M05 Path Traversal Blocked
  - Endpoint: GET /api/v1/{project_id}/files/%2e%2e%2Fetc%2Fpasswd ([files](backend/app/api/routes/files.py:12))
  - Expected: HTTP 400 Invalid/unsafe path
  - Acceptance: Exact 400
  - Evidence: mocked/M05/response.json
  - Failure handling: Any non-400 → FAIL

- M06 Absolute Path Blocked
  - Endpoint: GET /api/v1/{project_id}/files/%2Fetc%2Fpasswd
  - Expected: HTTP 400
  - Acceptance: Exact 400
  - Evidence: mocked/M06/response.json
  - Failure handling: Any non-400 → FAIL

- M07 Safe Nonexistent File
  - Endpoint: GET /api/v1/{project_id}/files/does-not-exist.txt
  - Expected: HTTP 404
  - Acceptance: Exact 404
  - Evidence: mocked/M07/response.json
  - Failure handling: Any non-404 → FAIL

- M08 Symlink Escape Blocked (if symlinks supported)
  - Setup: symlink inside workspace pointing outside (document in notes)
  - Endpoint: GET /api/v1/{project_id}/files/symlinked-escape/secret
  - Expected: HTTP 400 invalid/unsafe path
  - Acceptance: Exact 400
  - Evidence: mocked/M08/response.json; mocked/M08/notes.txt (setup)
  - Failure handling: Any non-400 → FAIL

- M09 Workspace Artifacts Check
  - Action: GET /api/v1/{project_id}/files/.codex/result.json then inspect fields
  - Expected: 200; result.json.status="success"; created_files include README.md, app.py, tests/test_cli.py
  - Acceptance: Status and created_files match expectations
  - Evidence: mocked/M09/result.json; mocked/M09/result_excerpt.txt; optional mocked/M09/dirlist.txt
  - Failure handling: Missing or malformed result → FAIL

Live Mode (Requires USE_DUMMY_WORKER=False; worker image set; docker socket mounted)
- L01 Worker Env Presence (instrumentation)
  - Endpoint: POST /api/v1/projects/ ([projects](backend/app/api/routes/projects.py:20))
  - Expected worker behavior via [run_codex_job()](backend/app/services/codex_runner.py:60): docker run -v /workspace and -e OPENAI_* passed
  - Expected: HTTP 200; .codex/result.json contains logs:
    - OPENAI_API_KEY=present|absent, OPENAI_ORG_ID=present|absent, OPENAI_PROJECT=present|absent (no values)
  - Acceptance: Presence-only logging lines exist; no secret values; status in {"success","error"} with summary
  - Evidence: live/L01/response.json; live/L01/project_id.txt; live/L01/result.json; live/L01/result_excerpt.txt
  - Failure handling: Missing logs or any leaked value → FAIL (redact in evidence but mark FAIL)

- L02 Create Project Live
  - Endpoint: POST /api/v1/projects/
  - Payload: {"instruction":"Generate a minimal Python CLI project that prints the first 10 Fibonacci numbers and includes a basic test."}
  - Expected: HTTP 200; result.json exists with status in {"success","error"} and human summary
  - Acceptance: result.json written; no secrets printed; if success, README.md, app.py, tests/test_cli.py created by minimal live worker
  - Evidence: live/L02/response.json; live/L02/result.json; live/L02/result_excerpt.txt; live/L02/files.json
  - Failure handling: Non-200 or missing result.json → FAIL

- L03 List Files Live
  - Endpoint: GET /api/v1/{project_id}/files
  - Expected: Includes .codex/request.json and .codex/result.json; other files may include README.md, app.py, tests/test_cli.py
  - Acceptance: .codex artifacts present
  - Evidence: live/L03/files.json
  - Failure handling: Missing .codex artifacts → FAIL

- L04 Get Representative File
  - Endpoint: GET /api/v1/{project_id}/files/app.py
  - Expected: 200; non-empty contents
  - Acceptance: contents length &gt; 0
  - Evidence: live/L04/app.json
  - Failure handling: 4xx/5xx or empty contents → FAIL

- L05 Edit Job Live
  - Endpoint: POST /api/v1/{project_id}/jobs ([jobs](backend/app/api/routes/jobs.py:12))
  - Payload: {"job_type":"edit","instruction":"Append a comment line to app.py describing the change."}
  - Expected: 200; result.json shows modified_files or structured errors
  - Acceptance: API 200; result.json present; logs show presence-only env lines
  - Evidence: live/L05/response.json; live/L05/result.json; live/L05/result_excerpt.txt
  - Failure handling: Non-200 or missing result.json → FAIL

- L06 Error Handling / Timeout
  - Endpoint: POST /api/v1/projects/ with instruction containing "force_error" to trigger error path
  - Expected: API 200; result.json status="error"; errors list with "forced_error"; API remains responsive
  - Acceptance: Structured error captured; no crash loops
  - Evidence: live/L06/response.json; live/L06/result.json; live/L06/result_excerpt.txt; live/L06/notes.txt
  - Failure handling: Missing errors[] or non-error status despite force → FAIL

- L07 Rollback to Mocked
  - See Appendix B
  - Acceptance: M01–M04 pass after rollback
  - Evidence: live/L07/notes.txt; mocked/RERUN/summary.txt
  - Failure handling: Any regression → FAIL

Evidence Capture Checklist (per test)
- Always store: response.json (primary call), project_id.txt (first creation call), result.json (if applicable), result_excerpt.txt
- For file validations: files.json and index.json (or file.json)
- For workspace checks: dirlist.txt (optional, host-side)
- For setup-dependent tests (e.g., M08): notes.txt describing setup and any deviations
